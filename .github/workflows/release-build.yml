name: Release Build

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: release-build-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build-lsp:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x64
            use-zigbuild: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux-arm64
            use-zigbuild: true
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: macos-arm64
            use-zigbuild: false
          - os: macos-13
            target: x86_64-apple-darwin
            platform: macos-x64
            use-zigbuild: false
          - os: ubuntu-latest
            target: x86_64-pc-windows-gnu
            platform: windows-x64
            use-zigbuild: false
          - os: ubuntu-latest
            target: aarch64-pc-windows-gnullvm
            platform: windows-arm64
            use-zigbuild: false

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cargo-zigbuild
        if: matrix.use-zigbuild
        run: pip install cargo-zigbuild

      - name: Install cross
        if: contains(matrix.target, 'windows')
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build LSP
        run: |
          if [ "${{ matrix.use-zigbuild }}" = "true" ]; then
            cargo zigbuild --release --target ${{ matrix.target }} --bin raven
          elif [ "${{ contains(matrix.target, 'windows') }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} --bin raven
          else
            cargo build --release --target ${{ matrix.target }} --bin raven
          fi

      - name: Create archive
        run: |
          mkdir -p dist
          if [[ "${{ matrix.platform }}" == *"windows"* ]]; then
            cp target/${{ matrix.target }}/release/raven.exe dist/
            cp LICENSE dist/
            cd dist && zip -r ../raven-${{ matrix.platform }}.zip .
          else
            cp target/${{ matrix.target }}/release/raven dist/
            cp LICENSE dist/
            cd dist && zip -r ../raven-${{ matrix.platform }}.zip .
          fi

      - name: Upload LSP artifact
        uses: actions/upload-artifact@v4
        with:
          name: lsp-${{ matrix.platform }}
          path: raven-${{ matrix.platform }}.zip
          retention-days: 30

  build-vscode:
    needs: build-lsp
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [darwin-arm64, darwin-x64, linux-x64, linux-arm64, win32-x64, win32-arm64]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Download LSP artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: lsp-*
          path: lsp-binaries

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          cd editors/vscode
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - name: Install dependencies
        run: |
          cd editors/vscode
          npm install

      - name: Compile extension
        run: |
          cd editors/vscode
          npx esbuild src/extension.ts --bundle --platform=node --outfile=dist/extension.js --external:vscode --minify

      - name: Copy LSP binary
        run: |
          cd editors/vscode
          mkdir -p bin
          case "${{ matrix.target }}" in
            darwin-arm64) cp ../../lsp-binaries/lsp-macos-arm64/raven-macos-arm64.zip bin/ && cd bin && unzip raven-macos-arm64.zip && rm -f raven-macos-arm64.zip ;;
            darwin-x64) cp ../../lsp-binaries/lsp-macos-x64/raven-macos-x64.zip bin/ && cd bin && unzip raven-macos-x64.zip && rm -f raven-macos-x64.zip ;;
            linux-x64) cp ../../lsp-binaries/lsp-linux-x64/raven-linux-x64.zip bin/ && cd bin && unzip raven-linux-x64.zip && rm -f raven-linux-x64.zip ;;
            linux-arm64) cp ../../lsp-binaries/lsp-linux-arm64/raven-linux-arm64.zip bin/ && cd bin && unzip raven-linux-arm64.zip && rm -f raven-linux-arm64.zip ;;
            win32-x64) cp ../../lsp-binaries/lsp-windows-x64/raven-windows-x64.zip bin/ && cd bin && unzip raven-windows-x64.zip && rm -f raven-windows-x64.zip ;;
            win32-arm64) cp ../../lsp-binaries/lsp-windows-arm64/raven-windows-arm64.zip bin/ && cd bin && unzip raven-windows-arm64.zip && rm -f raven-windows-arm64.zip ;;
          esac

      - name: Package extension
        run: |
          cd editors/vscode
          vsce package --target ${{ matrix.target }}

      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-${{ matrix.target }}
          path: editors/vscode/*.vsix
          retention-days: 30
